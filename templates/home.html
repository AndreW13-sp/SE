<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Text To Speech Converter App</title>
   <!-- Bootstrap Integration -->
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
   <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
</head>
<body>
   <div class="container">
      <form id="mySpeechfile" class="my-4">
         <div class="mb-3">
            <label for="file" class="form-label">Select File (Audio Only)</label>
            <input type="file" name="audioFile" id="file" class="form-control" accept="audio/wav" />
         </div>
         <button type="submit" class="btn btn-primary">Speech to text</button>
      </form>
      <div>
         <textarea name="write" id="write" class="form-control" cols="30" rows="10"></textarea>
         <button id="submit3" class="btn btn-warning mt-2">Convert to speech</button>
      </div>
   </div>
   
   <!--<script src="//cdn.jsdelivr.net/npm/eruda"></script>
   <script>eruda.init();</script>-->
   <script type="text/javascript" charset="utf-8">
      const fileUploader = document.getElementById("mySpeechfile");
      const mytext= document.getElementById('write')
      const submitbtn= document.getElementById('submit3')
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      let audio;
      submitbtn.addEventListener('click',(event)=>{
         event.preventDefault()
         sendText(mytext.value)
         audioPlayback()
      })

      function sendText(text) {
         fetch("http://127.0.0.1:5000/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
               action: "TextToSpeech",
               text: text || "Default text!"
            })
         })
         .then(res => res.arrayBuffer())
         .then(arrayBuffer => audioCtx.decodeAudioData(arrayBuffer))
         .then(decodedAudio => { audio = decodedAudio; })
         .catch(err => console.error(err));
      }
      
      function audioPlayback() {
         const sound = audioCtx.createBufferSource();
         sound.buffer = audio;
         sound.connect(audioCtx.destination);
         sound.start(audioCtx.currentTime);
      }
      
      fileUploader.addEventListener("submit", function (event) {
         event.preventDefault();
         
         const formData = new FormData();
         formData.append("action", "SpeechToText");
         formData.append("speech_file", this.file.files[0], { type: "audio/wav" });
         
         // console.assert(false);
         
         fetch("/upload", { method: "POST", body: formData })
            .then(res => res.json())
            .then(data => console.log(data))
            .catch(err => console.error(err));
      });
   </script>
</body>
</html>